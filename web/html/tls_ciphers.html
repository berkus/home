<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
lang="en" xml:lang="en">
<head>
<title>Choosing TLS Ciphers</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="7 August 2011"/>
<meta name="author" content="aldrin j d'souza"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>



</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Choosing TLS Ciphers</h1>


<p>
I've resolved to write something here once a week (regardless of how pointless the updates may
be). For most part, this note is an outcome of this silly resolution; the remaining has to do with
an experiment I just finished.
</p>
<p>
I've been fooling around with <a href="http://nginx.org">nginx</a> lately. It is a lightweight web server that I'm considering for
use as a lean HTTP payload dispatcher for some homegrown REST server implementations. One of the
requirements from applications that I typically write is a secure communication channel, so here's
an experiment to quantify the impact of using TLS with nginx.
</p>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Base Numbers </h2>
<div class="outline-text-2" id="text-1">

<p>Consider the following configuration,
</p>



<pre class="src src-conf"><span style="color: #ffd700;">worker_processes</span>  1;
<span style="color: #cdcd00; font-size: 105%;">events</span> {
    <span style="color: #ffd700;">worker_connections</span>  1024;
<span style="color: #ffd700;">}</span>
<span style="color: #cdcd00; font-size: 105%;">http</span> {
    <span style="color: #cdcd00; font-size: 105%;">server</span> {
        <span style="color: #ffd700;">listen</span> 8080;
        <span style="color: #cdcd00; font-size: 105%;">location /</span> {
            <span style="color: #ffd700;">root</span>   html;
        <span style="color: #ffd700;">}</span>
    <span style="color: #ffd700;">}</span>
<span style="color: #ffd700;">}</span>
</pre>



<p>
The document root contains just a 100MB (named <code>100M</code>) file that the client will ask for.
</p>


<pre class="example">&gt; ab http://localhost:8080/100M | grep "Transfer rate:"
Transfer rate:          646924.56 [Kbytes/sec] received
</pre>


<p>
So, <code>GET</code> over plain HTTP gives me around 650MB/sec. This is on a VM running on my laptop, so the
absolute numbers don't matter all that much, all I'm interested in at the moment is the relative hit
one takes by introducing security into the system. To do that, I enable the SSL in nginx and retry.
</p>


<pre class="src src-conf"><span style="color: #cdcd00; font-size: 105%;">http</span> {
    <span style="color: #cdcd00; font-size: 105%;">server</span> {
        <span style="color: #ffd700;">listen</span> 8443;
        <span style="color: #ffd700;">ssl</span> on;
        <span style="color: #ffd700;">ssl_certificate</span> nginx.crt;
        <span style="color: #ffd700;">ssl_certificate_key</span> nginx.key;
</pre>



<p> 
The transfer rate drops spectacularly!
</p>


<pre class="example">&gt; ab https://localhost:8443/100M | grep "Transfer rate:"
Transfer rate:          56762.58 [Kbytes/sec] received
</pre>


<p>
The rate is now around 56MB/sec. That, I guess, is the price you pay for that cozy warm sense of
'security'. If you look into the <code>ab</code> output, you'll notice that the cipher negotiated for the
connection is <code>DHE-RSA-AES256-SHA</code>. Would other ciphers fare better? Can we quantify their
performance and find one that hits the sweet spot between security and performance?
</p>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">Choose Ciphers </h2>
<div class="outline-text-2" id="text-2">

<p>I tweaked nginx configuration to restrict the ciphers it uses. I disabled older versions of SSL and
chose only those <a href="http://www.openssl.org/docs/apps/ciphers.html">ciphers</a> that can work with the RSA keypair I'm using in my setup. Here is the
configuration again:
</p>



<pre class="src src-conf"><span style="color: #cdcd00; font-size: 105%;">http</span> {
    <span style="color: #cdcd00; font-size: 105%;">server</span> {
        <span style="color: #ffd700;">listen</span> 8443;
      <span style="color: #ffd700;">ssl</span> on;
      <span style="color: #ffd700;">ssl_certificate</span> nginx.crt;
      <span style="color: #ffd700;">ssl_certificate_key</span> nginx.key;
        <span style="color: #ffd700;">ssl_protocols</span> TLSv1;
        <span style="color: #ffd700;">ssl_ciphers</span> TLSv1+aRSA;
</pre>



<p> 
Next, I measure the transfer rates using the following <a href="https://github.com/aldrin/ajd/blob/master/code/misc/choose_tls_ciphers.py">script</a>:
</p>



<pre class="src src-python"><span style="color: #87ff87; font-style: italic;">#!/usr/bin/env python</span>
<span style="color: #87ff87; font-style: italic;"># -*- coding: utf-8 -*-</span>

<span style="color: #ffd700;">COUNT</span> = <span style="color: #ffaf87;">'1'</span>
<span style="color: #ffd700;">DATA</span> = <span style="color: #ffaf87;">'100M'</span>
<span style="color: #ffd700;">PORT</span> = <span style="color: #ffaf87;">'8443'</span>
<span style="color: #ffd700;">CIPHERS</span> = <span style="color: #ffaf87;">'TLSv1+aRSA'</span>
<span style="color: #ffd700;">SERVER</span> = <span style="color: #ffaf87;">'localhost'</span>
<span style="color: #ffd700;">AB</span> = <span style="color: #ffaf87;">'/home/aldrin/pkg/apache/bin/ab'</span>
<span style="color: #ffd700;">OPENSSL</span> = <span style="color: #ffaf87;">'/home/aldrin/pkg/openssl/bin/openssl'</span>
<span style="color: #ffd700;">URL</span> = <span style="color: #ffaf87;">'https://{0}:{1}/{2}'</span>.format(SERVER, PORT, DATA)


<span style="color: #ffafaf; font-size: 105%;">def</span> <span style="color: #0087ff; font-size: 105%; font-weight: bold;">measure_cipher_rate</span>():
    <span style="color: #ffaf87;">""" Runs the Apache HTTP benchmark tools iteratively over the a subset of ciphers and prints</span>
<span style="color: #ffaf87;">    their transfer rates."""</span>

    <span style="color: #ffafaf; font-size: 105%;">from</span> subprocess <span style="color: #ffafaf; font-size: 105%;">import</span> check_output
    <span style="color: #ffafaf; font-size: 105%;">from</span> operator <span style="color: #ffafaf; font-size: 105%;">import</span> itemgetter
    rates = {}
    openssl_cmd = <span style="color: #ffaf87;">'{0} ciphers -v {1}'</span>.format(OPENSSL, CIPHERS)
    openssl_out = check_output(openssl_cmd.split())
    ciphers = [c.split()[0] <span style="color: #ffafaf; font-size: 105%;">for</span> c <span style="color: #ffafaf; font-size: 105%;">in</span> openssl_out.split(<span style="color: #ffaf87;">'\n'</span>) <span style="color: #ffafaf; font-size: 105%;">if</span> <span style="color: #87d7ff; text-decoration: underline;">len</span>(c) &gt; 0]
    <span style="color: #ffafaf; font-size: 105%;">for</span> cipher <span style="color: #ffafaf; font-size: 105%;">in</span> ciphers:
        <span style="color: #ffafaf; font-size: 105%;">try</span>:
            ab_cmd = <span style="color: #ffaf87;">'{0} -f tls1 -n {1} -Z {2} {3}'</span>.format(AB, COUNT, cipher, URL)
            ab_out = check_output(ab_cmd.split(), stderr=<span style="color: #87d7ff; text-decoration: underline;">file</span>(<span style="color: #ffaf87;">'/dev/null'</span>))
            rate_line = [l <span style="color: #ffafaf; font-size: 105%;">for</span> l <span style="color: #ffafaf; font-size: 105%;">in</span> ab_out.split(<span style="color: #ffaf87;">'\n'</span>) <span style="color: #ffafaf; font-size: 105%;">if</span> l.startswith(<span style="color: #ffaf87;">'Transfer rate:'</span>)][0]
            rates[cipher] = <span style="color: #87d7ff; text-decoration: underline;">float</span>(rate_line.split(<span style="color: #ffaf87;">':'</span>)[1].split(<span style="color: #ffaf87;">'['</span>)[0].strip())
        <span style="color: #ffafaf; font-size: 105%;">except</span>:
            <span style="color: #ffafaf; font-size: 105%;">print</span> <span style="color: #ffaf87;">'unsupported cipher:'</span>, cipher
    <span style="color: #ffafaf; font-size: 105%;">for</span> (k, v) <span style="color: #ffafaf; font-size: 105%;">in</span> <span style="color: #87d7ff; text-decoration: underline;">sorted</span>(rates.iteritems(), key=itemgetter(1)):
        <span style="color: #ffafaf; font-size: 105%;">print</span> <span style="color: #ffaf87;">'{0:&lt;30} {1}'</span>.format(k, v)


<span style="color: #ffafaf; font-size: 105%;">if</span> <span style="color: #87d7ff; text-decoration: underline;">__name__</span> == <span style="color: #ffaf87;">'__main__'</span>:
    measure_cipher_rate()
</pre>




<p>
Here's the output:
</p>


<pre class="example">EXP-EDH-RSA-DES-CBC-SHA        0.0
ECDHE-RSA-DES-CBC3-SHA         16864.15
DES-CBC3-SHA                   16865.4
EDH-RSA-DES-CBC3-SHA           17100.67
EXP-RC2-CBC-MD5                24222.03
DHE-RSA-SEED-SHA               31086.12
IDEA-CBC-SHA                   32385.48
SEED-SHA                       32788.36
EDH-RSA-DES-CBC-SHA            35692.33
EXP-DES-CBC-SHA                35932.88
DES-CBC-SHA                    38223.12
DHE-RSA-CAMELLIA256-SHA        44671.38
AES256-SHA                     48434.37
CAMELLIA256-SHA                48953.65
DHE-RSA-AES256-SHA             50972.24
ECDHE-RSA-AES256-SHA           51090.07
CAMELLIA128-SHA                54000.49
ECDHE-RSA-AES128-SHA           54216.11
DHE-RSA-CAMELLIA128-SHA        54522.32
DHE-RSA-AES128-SHA             57371.71
AES128-SHA                     59464.51
RC4-SHA                        70136.63
ECDHE-RSA-RC4-SHA              71215.6
RC4-MD5                        87444.48
EXP-RC4-MD5                    94582.44
ECDHE-RSA-NULL-SHA             138267.59
NULL-SHA                       147383.06
NULL-MD5                       191907.72
</pre>



<p>
<code>EXP-EDH-RSA-DES-CBC-SHA</code> fails the handshake, I'm guessing that is because it uses a very small key
size (40). The <code>NULL</code> ciphers obviously perform the best, but they are useless. The default choice
<code>DHE-RSA-AES256-SHA</code> isn't all that bad, but it is certainly not the best. The <code>RC4</code> ciphers live
upto their reputation of performance, but unfortunately I can't choose them without raising a few
eyebrows. What choices do we have then, realistically?
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">Realistically </h2>
<div class="outline-text-2" id="text-3">

<p>Realistically, our selection of ciphers is too permissive. <code>MD5</code> is a strict no-no and <code>RC4</code> is
considered weak, so let's tweak things to a more reasonable set: from <code>TLSv1+aRSA</code> to
<code>TLSv1+aRSA+HIGH:!MD5</code>. Here, then, is my final <code>nginx.conf</code>, in its entirety:
</p>


<pre class="src src-conf"><span style="color: #ffd700;">worker_processes</span>  1;
<span style="color: #cdcd00; font-size: 105%;">events</span> {
    <span style="color: #ffd700;">worker_connections</span>  1024;
<span style="color: #ffd700;">}</span>
<span style="color: #cdcd00; font-size: 105%;">http</span> {
    <span style="color: #cdcd00; font-size: 105%;">server</span> {
        <span style="color: #ffd700;">listen</span> 8443;
      <span style="color: #ffd700;">ssl</span> on;
      <span style="color: #ffd700;">ssl_certificate</span> nginx.crt;
      <span style="color: #ffd700;">ssl_certificate_key</span> nginx.key;
        <span style="color: #ffd700;">ssl_protocols</span> TLSv1;
        <span style="color: #ffd700;">ssl_ciphers</span> TLSv1+aRSA+HIGH:!MD5;
        <span style="color: #cdcd00; font-size: 105%;">location /</span> {
            <span style="color: #ffd700;">root</span>   html;
        <span style="color: #ffd700;">}</span>
    <span style="color: #ffd700;">}</span>
<span style="color: #ffd700;">}</span>
</pre>



<p>
Strictly speaking, I don't think the <code>!MD5</code> bit is required (the <code>TLSv1+HIGH</code> should be enough for
all <code>MD5</code> based ciphers to be dropped.) I re-run the script and here's what I get:
</p>


<pre class="example">DES-CBC3-SHA                   16321.05
EDH-RSA-DES-CBC3-SHA           16853.38
ECDHE-RSA-DES-CBC3-SHA         17494.3
CAMELLIA256-SHA                50150.32
DHE-RSA-CAMELLIA256-SHA        51007.79
ECDHE-RSA-AES256-SHA           53051.46
CAMELLIA128-SHA                53740.01
AES256-SHA                     53762.62
DHE-RSA-CAMELLIA128-SHA        53861.51
DHE-RSA-AES256-SHA             54784.57
AES128-SHA                     58129.02
ECDHE-RSA-AES128-SHA           58205.45
DHE-RSA-AES128-SHA             65476.98
</pre>


<p>
Turns out, with a reasonably strong cipher (<code>DHE-RSA-AES128-SHA</code>) we can extract around 10MB/sec
more out of the system than with the default cipher that the system picks for us. The gain isn't
spectacular (when compared with plain HTTP rates), but it might be handy if you're clutching for
straws.
</p>
<p>
And on that uninspiring note, this post shall suddenly shut itself.
</p>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 7 August 2011</p>
<p class="author">Author: aldrin j d'souza</p>
<p class="creator">Org version 7.7 with Emacs version 23</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
